<html>
    <head>
        <style type = "text/css">
            .picture{
                max-height: 10em;
                max-width: 10em;

            }
            .hidden {
                display: none;
            }
            .row{
                display: flex;
            }
            .myBtn{
                visibility: visible;
            }
            .moveButten {
                display: none;
            }
            .grid {
                display: inline-grid;
                grid-template-columns: 1fr 1fr 1fr 1fr;

            }
            .element {
                color: blue;
                border: solid black 1px;
                padding: 2px;
            }
            .text {
                visibility: visible;

            }
            .lobbyGrid{
                display: inline-grid;
                grid-template-columns: auto auto;
            }
            .lobbyGrid > * {
                padding: 3px;
                border: 1px solid black;
            }
            .huge{
                font-size: 40px;
            }


        </style>
    </head>




    <body>
        <h1>
            Mortal
        </h1>
        <div id="logInScreen">
            <div id="enterUserName">
                <label class="text">
                    enter username

                </label>
                <input type="text" id="usernameInputBox">

            </div>
            <div id="enterGameID">
                <label class="text">
                    enter game ID

                </label>
                <input type="text" id="IdInputBox">

            </div>
            <div>
                <button class = "myBtn" id = "joinButton">join game</button>

            </div>
        </div>
        <div id = "lobby" class="hidden">
            <div class="lobbyGrid">
                <div>
                    player 1
                </div>
                <div id = "playerSpot1">
                    waiting...
                </div>
                <div>
                    player 2
                </div>
                <div id = "playerSpot2">
                    waiting...
                </div>
                <div >
                    player 3
                </div>
                <div id = "playerSpot3">
                    waiting...
                </div>
            </div>
        </div>
        <div ID = "gamebord" class="hidden">
            <div class="row">
                <div class="hidden" id="move1">
                    <img class="picture" src="game images/normalAttack.jpg"/>
                    <div>
                        <button class="myBtn" onclick="slectTarget()">normalAttack</button>
                        <div class="hidden" id="normalattackvariants">
                            <button class="myBtn" onclick="broadcastMove('normalAttack1')" id="normalAttackFirst"></button>
                            <div>
                                <button class="myBtn" onclick="broadcastMove('normalAttack2')" id="normalAttackSecond"></button>
                                <div>
                                    <button class="myBtn" onclick="broadcastMove('normalAttack3')" id="normalAttackThird"></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="hidden" id = "move2">
                    <img class="picture" src="game images/specialAttack.jpg"/>
                    <div>
                        <button class="myBtn" onclick="broadcastMove('specialAttack')">specialAttack</button>
                    </div>
                </div>
                <div class="hidden" id = "move3">
                    <img class="picture" src="game images/block.jpg"/>
                    <div>
                        <button class="myBtn" onclick="broadcastMove('block')">block</button>
                    </div>
                </div>
                <div class="hidden" id="move4">
                    <img class="picture" src="game images/specialblock.jpg"/>
                    <div>
                        <button class="myBtn" onclick="broadcastMove('specialblock')">specialblock</button>
                    </div>
                </div>
                <div class="hidden" id = "move5">
                    <img class="picture" src="game images/reflect.jpg"/>
                    <div>
                        <button class="myBtn" onclick="broadcastMove('reflect')">reflect</button>
                    </div>
                </div>
                <div class="hidden" id = "move6">
                    <img class="picture" src="game images/healing.jpg"/>
                    <div>
                        <button class="myBtn" onclick="broadcastMove('heal')">healing</button>
                    </div>
                </div>
                <div class="hidden" class="huge" id="gameOverMessage">
                    you have been eliminated
                </div>
                <div class="hidden" class="huge" id="stunedMessage">
                    you are stuned this round
                </div>
                <div class="grid">
                    <div class="element">names </div>
                    <div class="element" id="player1Header"></div>
                    <div class="element" id="player2Header"></div>
                    <div class="element" id="player3Header"></div>
                    <div class="element">last moves </div>
                    <div class="element" id="perviusMove1Display"></div>
                    <div class="element" id="perviusMove2Display"></div>
                    <div class="element" id="perviusMove3Display"></div>
                    <div class="element">next moves </div>
                    <div class="element" id="nextMove1Display"></div>
                    <div class="element" id="nextMove2Display"></div>
                    <div class="element" id="nextMove3Display"></div>
                    <div class="element">healths </div>
                    <div class="element" id="health1display">14 </div>
                    <div class="element" id="health2display">14 </div>
                    <div class="element" id="health3display">14 </div>
                </div>
            </div>
        </div>
        <script>
            "use strict";
            let numPlayers = 0;
            const playerList = [];
            let playersPreviousMoves = {};
            const playersNextMoves = {};
            const playersHealths = {};
            const hasSpecialBlock = {};
            let mode = "logIn";
            const allStoredMoves = [];
            let globalWebSocket = undefined;
            let myName = undefined;
            const ButtonsPointTo = [];
            const webSocketEndpoint = "wss://vo41xadzr9.execute-api.us-east-1.amazonaws.com/production";
            let playersLeft = 3;
            const playerToBeStunned = {};
            const normalAttackButtens = [];
            // ==== Functions that dispatch incoming messages ====

            function onMessage(message) {
                console.log(message);
                if (mode === "lobby"){
                    lobbyMessage(message);
                }
                else{
                    if (mode === "playing"){
                        gamePlayMessage(message);
                    }
                }
            }

            function lobbyMessage(messageText){
                //checks if message is about a player joining game
                const message = JSON.parse(messageText);
                console.log(message)
                if(message.trigger === "playerAdded") {
                    let i = message.players.length;
                    numPlayers = message.players.length;
                    playerList.length = 0;
                    while (i>0){
                        const playerSpot = document.getElementById(`playerSpot${i}`);
                        playerSpot.innerText = message.players[i - 1];
                        playerList.unshift(message.players[i - 1]);
                        i = i - 1;
                    }
                    if (numPlayers === 3) {
                        startGame();
                    }
                }
            }


            function gamePlayMessage(messageText){
                const message = JSON.parse(messageText);
                if (message.trigger === "messageSent") {
                    let i = 0;
                    while (i < 3){
                        if (playerList[i] === message.sender){
                            document.getElementById("nextMove" + (i + 1) + "Display").innerText = "selected";
                        }
                        i = i + 1;
                    }
                    setMove(message.data.move,message.sender);
                }

            }


            function receivedMove(move){

            }

            // ==== Functions that do XXXX =====

            /* Returns the content of the input element with the given id. */



            function startGame(){
                console.log("startgame");
                const loby = document.getElementById("lobby");
                loby.classList.add("hidden");
                const gameBoard = document.getElementById("gamebord");
                gameBoard.classList.remove("hidden");
                const moveElementIds = ["move1", "move2", "move3", "move4", "move5", "move6"];
                moveElementIds.forEach(function(moveElementId) {
                    const moveElement = document.getElementById(moveElementId);
                    moveElement.classList.remove("hidden");
                })
                mode = "playing";
                playersNextMoves[playerList[0]] = null;
                playersNextMoves[playerList[1]] = null;
                playersNextMoves[playerList[2]] = null;
                playersPreviousMoves[playerList[0]] = null;
                playersPreviousMoves[playerList[1]] = null;
                playersPreviousMoves[playerList[2]] = null;
                allStoredMoves.push(playersPreviousMoves);
                allStoredMoves.push(playersNextMoves);
                playersHealths[playerList[0]] = 14;
                playersHealths[playerList[1]] = 14;
                playersHealths[playerList[2]] = 14;
                hasSpecialBlock[playerList[0]] = true;
                hasSpecialBlock[playerList[1]] = true;
                hasSpecialBlock[playerList[2]] = true;
                const possibleMoves = ['normalAttack', 'specialAttack', 'block', 'specialblock', 'reflect', 'heal'];
                const firstPlayerNameSpot = document.getElementById("player1Header");
                const secondPlayerNameSpot = document.getElementById("player2Header");
                const thirdPlayerNameSpot = document.getElementById("player3Header");
                firstPlayerNameSpot.innerText = playerList[0];
                secondPlayerNameSpot.innerText = playerList[1];
                thirdPlayerNameSpot.innerText = playerList[2];
                const normalAttack1 = document.getElementById("normalAttackFirst");
                const normalAttack2 = document.getElementById("normalAttackSecond");
                let firstWorked = false
                const firstMove = document.getElementById("normalAttackFirst");
                const SecondMove = document.getElementById("normalAttackSecond");
                const ThirdMove = document.getElementById("normalAttackThird");
                playerToBeStunned[playerList[0]] = false;
                playerToBeStunned[playerList[1]] = false;
                playerToBeStunned[playerList[2]] = false;
                if(playerList[0] !== myName){
                    firstMove.innerText = playerList[0];
                    normalAttackButtens.push(playerList[0]);
                }
                else {
                    firstMove.classList.add("hidden");
                    normalAttackButtens.push(null);
                }
                if(playerList[1] !== myName) {
                    SecondMove.innerText = playerList[1];
                    normalAttackButtens.push(playerList[1]);
                }
                else {
                    SecondMove.classList.add("hidden");
                    normalAttackButtens.push(null);
                }
                if(playerList[2] !== myName){
                    ThirdMove.innerText = playerList[2];
                    normalAttackButtens.push(playerList[2]);
                }
                else {
                    ThirdMove.classList.add("hidden");
                    normalAttackButtens.push(null);
                }


            }

            function broadcastMove(move){
                ///needs to be updated to deal with deth

                const message = {"move":move};
                const fullMessage = {"action":"sendMessage","data":message};
                const messageText = JSON.stringify(fullMessage);
                globalWebSocket.send(messageText);
                let i = 0;
                while (i < 3){
                    if(playerList[i] === myName){
                        if ((move !== "normalAttack1") && (move !== "normalAttack2") && (move !== "normalAttack3")){
                            document.getElementById("nextMove" + (i + 1) + "Display").innerText = move;
                        }
                        else {
                            let j = 0;
                            while (j < 3){
                                if (move === "normalAttack" + (j + 1)){
                                    document.getElementById("nextMove" +(i+1) + "Display").innerText = "normal Attack " + playerList[j];
                                }
                                j = j + 1;
                            }
                        }
                    }
                    i = i + 1;
                }

                setMove(move, myName);
            }

            function setMove(move,player){
                console.log("called set move", move, player);
                playersNextMoves[player] = move;
                console.log("the recorded playermoves are",playersNextMoves);
                if(((playersNextMoves[playerList[0]] !== null)&&(playersNextMoves[playerList[1]] !== null))&&(playersNextMoves[playerList[2]] !== null)){
                    makeMoves();
                }
            }



            function makeMoves() {
                console.log("time to make the moves");


                function specialAttack (actingPlayer){
                    console.log("special Attacked");
                    let whosAttacked = undefined;
                    let i = 0;
                    while (i < 3){
                        whosAttacked = playerList[i];
                        if (!( whosAttacked === actingPlayer)){
                            if (playersNextMoves[whosAttacked] === "specialblock"){
                            }
                            else{
                                if (playersNextMoves[whosAttacked] === "block"){
                                    playersHealths[whosAttacked] = playersHealths[whosAttacked] - 1;
                                }
                                else{
                                    if (playersNextMoves[whosAttacked] === "reflect"){
                                        console.log("noted reflection");
                                        let thirdPlayer = 0;
                                        while(thirdPlayer < 3) {
                                            if (!((thirdPlayer === whosAttacked) || (thirdPlayer === actingPlayer ))){
                                                if(((playersNextMoves[thirdPlayer] === "specialAttack") || (playerToBeStunned[thirdPlayer] === true))||(playersNextMoves[thirdPlayer] === ('normalAttack' + ((i + 1).toString(10))))){
                                                    //fixme remove playerToBeStuned part of condition
                                                    playersHealths[actingPlayer] = playersHealths[actingPlayer] - 2;
                                                }
                                                else{
                                                    playersHealths[whosAttacked] = playersHealths[whosAttacked] - 6;
                                                }
                                            }
                                            thirdPlayer = thirdPlayer + 1;
                                        }
                                    }
                                    else{
                                        playersHealths[whosAttacked] = playersHealths[whosAttacked] - 6;
                                    }
                                }
                            }
                        }
                        i = i + 1;
                    }
                    playerToBeStunned[actingPlayer] = true;
                    console.log("this is the player to be stuned varable after soposidly stunning the guy ",playerToBeStunned);
                }


                function block(actingPlayer){
                    console.log("blocked");
                }

                function specialBlocked(actingPlayer){
                    console.log("specialBlocked");
                    hasSpecialBlock[actingPlayer] = false
                }

                function Heal(actingPlayer){
                    console.log("entered heal function");
                    let healTarget = 0;
                    while (healTarget < 3) {
                        if (playerList[healTarget] === actingPlayer){
                            playersHealths[playerList[healTarget]] = playersHealths[playerList[healTarget]] + 2;
                        }
                        else{
                            if (!(((playersNextMoves[playerList[healTarget]] === 'block' )||( playersNextMoves[playerList[healTarget]] === 'specialblock'))||(playersHealths[playerList[healTarget]] < 1))){
                                playersHealths[playerList[healTarget]] = playersHealths[playerList[healTarget]] + 1;
                            }
                        }
                        healTarget = healTarget + 1;
                    }
                }


                function Reflect(actingPlayer){
                    console.log("reflected");
                }


                function normalAttack1(actingPlayer){
                    console.log("normal attacked player 1");
                    const opposingPlayer = playerList[0];
                    if (playersNextMoves[opposingPlayer] === 'block'){
                        playersHealths[opposingPlayer] =  playersHealths[opposingPlayer] - 1;
                    }
                    else{
                        if (playersNextMoves[opposingPlayer] === "specialblock"){
                        }
                        else{
                            if(playersNextMoves[opposingPlayer] === "reflect"){
                                let count = 0;
                                let thirdPlayer = null;
                                while (count < 3){
                                    thirdPlayer = playerList[count];
                                    if (!((thirdPlayer === actingPlayer)|| (thirdPlayer === opposingPlayer) )){
                                        if (((playersNextMoves[thirdPlayer] === "specialAttack") ||(playersNextMoves[thirdPlayer] === "normalAttack1"))||(playerToBeStunned[thirdPlayer] === true)){
                                            //update for whatever stun method you are uesing on specel attack
                                            playersHealths[actingPlayer] = playersHealths[actingPlayer] - 2;
                                        }
                                        else{
                                            playersHealths[opposingPlayer] = playersHealths[opposingPlayer] - 2;
                                        }
                                    }
                                    count = count + 1;
                                }
                            }
                            else{
                                playersHealths[opposingPlayer] = playersHealths[opposingPlayer] - 2;
                            }
                        }
                    }
                }


                function normalAttack2(actingPlayer){
                    console.log("normal attacked player 2");
                    const opposingPlayer = playerList[1];
                    if (playersNextMoves[opposingPlayer] === "block"){
                        playersHealths[opposingPlayer] =  playersHealths[opposingPlayer] - 1;
                    }
                    else{
                        if (playersNextMoves[opposingPlayer] === "specialblock"){
                        }
                        else{
                            if(playersNextMoves[opposingPlayer] === "reflect"){
                                let count = 0;
                                let thirdplayer = null;
                                while (count < 3){
                                    thirdplayer = playerList[count]
                                    if (!((thirdplayer === actingPlayer)|| (thirdplayer === opposingPlayer) )){
                                        if (((playersNextMoves[thirdplayer] === "specialAttack") ||(playersNextMoves[thirdplayer] === "normalAttack2"))||(playerToBeStunned[thirdplayer] === true)){
                                            playersHealths[actingPlayer] = playersHealths[actingPlayer] - 2;
                                        }
                                        else{
                                            playersHealths[opposingPlayer] = playersHealths[opposingPlayer] - 2;
                                        }
                                    }
                                    count = count + 1;
                                }
                            }
                            else{
                                playersHealths[opposingPlayer] = playersHealths[opposingPlayer] - 2;
                            }
                        }
                    }
                }
                function normalAttack3(actingPlayer){
                    console.log("normal attacked player 1");
                    const opposingplayer = playerList[2];
                    if (playersNextMoves[opposingplayer] === "block"){
                        playersHealths[opposingplayer] =  playersHealths[opposingplayer] - 1;
                    }
                    else{
                        if (playersNextMoves[opposingplayer] === "specialblock"){
                        }
                        else{
                            if(playersNextMoves[opposingplayer] === "reflect"){
                                let thirdPlayer = null;
                                let count = 0
                                while (count < 3){
                                    if (!((thirdPlayer === actingPlayer)|| (thirdPlayer === opposingplayer) )){
                                        if (((playersNextMoves[thirdPlayer] === "specialAttack") ||(playersNextMoves[thirdPlayer] === "normalAttack3"))||(playerToBeStunned[thirdPlayer] === true)){
                                            playersHealths[actingPlayer] = playersHealths[actingPlayer] - 2;
                                        }
                                        else{
                                            playersHealths[opposingplayer] = playersHealths[opposingplayer] - 2;
                                        }
                                    }
                                    count = count + 1;
                                }
                            }
                            else{
                                playersHealths[opposingplayer] = playersHealths[opposingplayer] - 2;
                            }
                        }
                    }
                }

                function stunned (actingPlayer){
                    console.log("calling stunned function");

                }



                let movingPlayer = 0;
                while (movingPlayer < 3){
                    // const functionMap = {
                    //   "stuned": stunned,
                    //   "specialAttack": specialAttack,
                    //   "heal": Heal,
                    // };
                    // const functionToCall = functionMap[playersNextMoves[playerList[movingPlayer]]];
                    // functionToCall(playerList[movingPlayer]);

                    if (playersNextMoves[playerList[movingPlayer]] === 'stuned'){
                        stunned(playerList[movingPlayer]);
                    }
                    if (playersNextMoves[playerList[movingPlayer]] === 'specialAttack'){
                        specialAttack (playerList[movingPlayer]);

                    }
                    if (playersNextMoves[playerList[movingPlayer]] === 'heal'){
                        Heal (playerList[movingPlayer]);

                    }
                    if (playersNextMoves[playerList[movingPlayer]] === 'reflect'){
                        Reflect (playerList[movingPlayer]);

                    }
                    if (playersNextMoves[playerList[movingPlayer]] === 'block'){
                        block (playerList[movingPlayer]);

                    }
                    if (playersNextMoves[playerList[movingPlayer]] === 'specialblock'){
                        specialBlocked (playerList[movingPlayer]);
                    }
                    if (playersNextMoves[playerList[movingPlayer]] === 'normalAttack1'){
                        normalAttack1(playerList[movingPlayer]);
                    }
                    if (playersNextMoves[playerList[movingPlayer]] === 'normalAttack2'){
                        normalAttack2(playerList[movingPlayer]);
                    }
                    if (playersNextMoves[playerList[movingPlayer]] === 'normalAttack3'){
                        normalAttack3(playerList[movingPlayer])
                    }
                    movingPlayer = movingPlayer + 1;

                }
                console.log("the player healths are ",playersHealths);
                let i = 0;
                while (i < 3){
                    playersPreviousMoves[playerList[i]] = playersNextMoves[playerList[i]];
                    playersNextMoves[playerList[i]] = null;
                    i = i + 1;
                }
                let ii = 0;
                let unStunTarget = undefined;
                while (ii < 3) {
                    unStunTarget = playerList[ii];
                    console.log(unStunTarget,playerToBeStunned,myName);
                    if (playerToBeStunned[unStunTarget] === true) {
                        playerToBeStunned[unStunTarget] = false;
                        console.log("about to check condition", myName," ",unStunTarget);
                        playersNextMoves[unStunTarget] = "stunned";
                        //if (myName === unStunTarget) {
                            //console.log("should brodcast ","stunned");
                            //broadcastMove("stunned");
                        //}
                    }
                    ii = ii + 1;
                }
                updateDisplay();
                if (playersHealths[myName] < 1){
                    console.log("Im dead");
                    let i2 = 1;
                    while (i2 < 7){
                        console.log("im dead");
                        document.getElementById("move" + i2).classList.add("hidden");
                        i2 = i2 + 1;
                    }
                    document.getElementById("gameOverMessage").classList.remove("hidden");
                }
                let j = 0;
                while (j < 3){
                    if (playersHealths[playerList[j]] < 1){
                        console.log("made it to im dead function condition = true");
                        playersNextMoves[playerList[j]] = "i'm dead";
                    }
                    j = j + 1;
                }

            }


            function updateDisplay() {
                const player1Health = document.getElementById("health1display");
                const player2Health = document.getElementById("health2display");
                const player3Health = document.getElementById("health3display");
                const player1CurrentMove = document.getElementById("nextMove1Display");
                const player2CurrentMove = document.getElementById("nextMove2Display");
                const player3CurrentMove = document.getElementById("nextMove3Display");
                player1Health.innerText = playersHealths[playerList[0]];
                player2Health.innerText = playersHealths[playerList[1]];
                player3Health.innerText = playersHealths[playerList[2]];
                let i = 0;
                let j = 0;
                let didPlayerINormalAttack = false;
                while (i < 3) {
                    didPlayerINormalAttack = false;
                    j = 0
                    while (j < 3) {
                        if (playersPreviousMoves[playerList[i]] === "normalAttack" + (j + 1)) {
                            console.log("should be here");
                            didPlayerINormalAttack = true;
                            console.log("normalAttack" + (playerList[j]));
                            document.getElementById("perviusMove" + (i + 1) + "Display").innerText = "normal Attack " + (playerList[j]);
                            console.log(document.getElementById("perviusMove" + (i + 1) + "Display").innerText);
                        }
                        j = j + 1;
                    }
                    if (didPlayerINormalAttack === false) {
                        console.log("shouldent be here");
                        document.getElementById("perviusMove" + (i + 1) + "Display").innerText = playersPreviousMoves[playerList[i]];
                    }
                    i = i + 1;
                }
                if (playersNextMoves[playerList[0]] === "stunned") {
                    player1CurrentMove.innerText = "stunned";
                }
                else {
                    player1CurrentMove.innerText = "";
                }
                if (playersNextMoves[playerList[1]] === "stunned"){
                    player2CurrentMove.innerText = "stunned";
                }
                else{
                    player2CurrentMove.innerText = "";
                }
                if(playersNextMoves[playerList[2]] === "stunned"){
                    player3CurrentMove.innerText = "stunned";
                }
                else{
                    player3CurrentMove.innerText = "";
                }
                if(playersNextMoves[myName] === "stunned"){
                    let count = 1;
                    while (count < 7){
                        document.getElementById("move" + count).classList.add("hidden");
                        count = count + 1;
                    }
                    document.getElementById("stunedMessage").classList.remove("hidden");
                }
                else{
                    let count2 = 1
                    while (count2 < 7){
                        document.getElementById("move" + count2).classList.remove("hidden");
                        count2 = count2 + 1;
                    }
                    document.getElementById("stunedMessage").classList.add("hidden");
                }
                if (hasSpecialBlock[myName] === false){
                    document.getElementById("move4").classList.add("hidden");
                }
            }


            function slectTarget(){
                console.log("playerslection acctavated");
                const button = document.getElementById("normalattackvariants");
                button.classList.remove("hidden");
            }

            function getInput(id) {
                const elem = document.getElementById(id);
                return elem.value;
            }

            function connect() {
                const webSocket = new WebSocket(webSocketEndpoint);
                webSocket.onmessage = function(event) {
                    console.log("Got a message");
                    onMessage(event.data);
                }
                function joinGame() {
                    const logInScreen = document.getElementById("logInScreen");
                    logInScreen.classList.add("hidden");
                    const gameId = getInput("IdInputBox");
                    const playerId = getInput("usernameInputBox");
                    const action = "joinGame";
                    const message = {action, gameId, playerId};
                    const messageText = JSON.stringify(message);
                    console.log(`Sending "${messageText}"`);
                    webSocket.send(messageText);
                    document.getElementById("lobby").classList.remove("hidden");
                    mode = "lobby";
                    myName = playerId;
                }
                globalWebSocket = webSocket;
                document.getElementById("joinButton").onclick = joinGame;
            }

            connect();



        </script>
    </body>



</html>